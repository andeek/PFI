Although the Thompson farm employed a five crop rotation, our comparison focuses on corn and soybeans since those are the two crops planted at the Boone farm.  After averaging expeneses by year, and over the number of fields, we plot the difference in expenses between the two farms (by crop) after selecting differences that are significantly different from zero.  

```{r,warning=FALSE,message=FALSE,echo=FALSE}
dat[complete.cases(dat),] %>% 
  filter(item_type == "Expense") %>%
  filter(crop %in% c("Corn")) %>%
  filter(item %in% c("Purch_Pert","Seed","Herbicides","Hedge_per_PL")) %>%
  group_by(farmer, year, crop, field_id,item) %>%
  summarise(total = sum(value)) %>%
  group_by(farmer,year,item) %>%
  summarise(avg_total = mean(total)) %>%
  ungroup() %>%
  spread(farmer,avg_total) %>%
  mutate(difference = Boone-Thompson) %>%
  ggplot() +
  geom_line(aes(x=year,y=difference,color=item)) +
  ggtitle('Difference (Boone-Thompson) in Average Expenses for Corn')


dat[complete.cases(dat),] %>% 
  filter(item_type == "Expense") %>%
  filter(crop %in% c("SB")) %>%
  filter(item %in% c("Purch_Pert","Seed","Herbicides","Hedge_per_PL")) %>%
  group_by(farmer, year, crop, field_id,item) %>%
  summarise(total = sum(value)) %>%
  group_by(farmer,year,item) %>%
  summarise(avg_total = mean(total)) %>%
  ungroup() %>%
  spread(farmer,avg_total) %>%
  mutate(difference = Boone-Thompson) %>%
  ggplot() +
  geom_line(aes(x=year,y=difference,color=item)) +
  ggtitle('Difference (Boone-Thompson) in Average Expenses for SB')

```


For both corn and soybeans the biggest cost discrepency is for fertilizer and herbicide.  The Boone farm consistently pays more per acre for fertilizer and herbicide.  Moreover, starting at around 1994 the difference between Thompson and Boon increases sharply, peaking in 2009.  In 2009, Boone payed approximatly $180/acre more for corn fertilizer and $110/acre more for soybean fertilizer.  The second biggest cost difference is for herbicide.  This expense is more stable, hovering around $25/acre more for Boone compared to Thompson.  These differences are likely a result of Thompson's organic farming practices.

There are also expenses that only Boone accrues.


```{r,warning=FALSE,message=FALSE,echo=FALSE}
boone_extra_expense<-dat[complete.cases(dat),] %>% 
  filter(item_type == "Expense") %>%
  filter(farmer=="Boone") %>%
  filter(crop %in% c("Corn")) %>%
  filter(item %in% c("Apply_NH4","Spring_Tillage","Purch_pert","Fall_Tillage")) %>%
  filter(value>.01) %>%
  group_by(year,item) %>%
  summarise(total = sum(value)) %>%
  ggplot() +
  geom_line(aes(x=year, y=total,linetype=item)) +
  ggtitle('Boone Extra Expenses for Corn')

boone_extra_expense

boone_extra_expense<-dat[complete.cases(dat),] %>% 
  filter(item_type == "Expense") %>%
  filter(farmer=="Boone") %>%
  filter(crop %in% c("SB")) %>%
  filter(item %in% c("Spring_Tillage","Purch_pert","Fall_Tillage","Apply_NH4")) %>%
  filter(value>.01) %>%
  group_by(year,item) %>%
  summarise(total = sum(value)) %>%
  ggplot() +
  geom_line(aes(x=year, y=total,linetype=item)) +
  ggtitle('Boone Extra Expenses for SB')

boone_extra_expense
```

The extra costs that Boone incur are for tillage (spring and fall), and applying Nitrogen to the soil where corn is planted.  The Nitrogen expenses drop preciptiously in 1994, and then gradually increase to an extra $12/acre in 2011.  Nitogen is not applied to the Boone soybean fields.  

Spring and fall tillage are also added approximatly $10/acre to the Boone farm.  As part of his organic farming practice, Thompson does not till his land.

Although Thompson has lower expenses than Boone, it could be a moot point if his yield is substanitally lower than Boone, too.  Therefore, we will also compare yields to see if Thompson is able to still produce despite spending less on fertilizers and herbicide.  From looking at time series plots of average yields, it appears that Thompson is able to consistently produce corn and soybeans at an equal, or slighly higher, level than the Boone farm.    


```{r,warning=FALSE,message=FALSE,echo=FALSE}
corn_yield<-dat[complete.cases(dat),] %>% 
  filter(item_type == "Unit Quantity") %>%
  filter(crop %in% c("Corn")) %>%
  group_by(farmer, year,field_id) %>%
  summarise(total = sum(value)) %>%
  group_by(farmer, year) %>%
  summarise(avg_total = mean(total)) %>%
  ggplot() +
  geom_line(aes(x=year, y=avg_total,color=farmer)) +
  ggtitle('Avg Corn Yields') +
  theme(legend.position="bottom")
  
sb_yield<-dat[complete.cases(dat),] %>% 
  filter(item_type == "Unit Quantity") %>%
  filter(crop %in% c("SB")) %>%
  group_by(farmer, year,field_id) %>%
  summarise(total = sum(value)) %>%
  group_by(farmer, year) %>%
  summarise(avg_total = mean(total)) %>%
  ggplot() +
  geom_line(aes(x=year, y=avg_total,color=farmer)) +
  ggtitle('Avg SB Yields') +
  theme(legend.position="bottom")

grid.arrange(corn_yield,sb_yield, ncol=2)
```

The last expense to consider is labor.  The data does not contain the number of hours each farmer put into his work.  However, we do have variables on labor return.  According to the Thompson report, labor return is calculated after all out of pocket costs are paid.  The Boone labor return for corn and soybeans is identical and fairly flat.  This is likely due to assumptions that Thompson made about labor hours on the Boone farm.  

```{r,warning=FALSE,message=FALSE,echo=FALSE}
dat[complete.cases(dat),] %>% 
  filter(item_type == "Derived") %>%
  filter(crop %in% c("Corn","SB")) %>%
  filter(item %in% c("Labor_Return","LaborandMR_dollar_per_A")) %>%
  group_by(farmer, year,crop,field_id,item) %>%
  summarise(total = sum(value)) %>%
  group_by(farmer, year,crop,item) %>%
  summarise(avg_total = mean(total)) %>%
  filter(item %in% c("Labor_Return")) %>%
  ggplot() +
  geom_line(aes(x=year, y=avg_total,color=crop)) +facet_wrap(~farmer)+
  ggtitle('Labor Return by Crop')
```

The data seems to show Thompson getting a greater labor return than Boone for both corn and soybeans.  However, without additional information about how labor returned is measured, and what assumptions are made in the calculation, it is difficult to say why or how much better Thompson is doing in terms of labor efficiency.  

## Building crop sequences
We are interested in the expenses incurred from sequential planting of crops in rotation. Due to the nature of the data we have available, this exploration will be limited to the Thompson dataset only, seeing as the Boone average data does not have rotation of crops.

```{r, echo=FALSE, fig.width=3.5, fig.height=3.5}
join_dat <- dat %>% 
  filter(item_type == "Expense") %>%
  filter(farmer == "Thompson") %>%
  mutate(year_before = year - 1) %>%
  left_join(dat[dat$item_type=="Expense",], by=c("farmer" = "farmer", "year_before" = "year", "field_id" = "field_id")) %>%
  mutate(two_crops = paste(crop.y, crop.x, sep="-")) %>%
  mutate(item.x = factor(item.x)) %>%
  group_by(year, two_crops, field_id)

seq_dat <- join_dat %>%
  summarise(total = sum(value.x)) %>%
  group_by(year, two_crops) %>%
  summarise(avg_total = mean(total)) %>%
  data.frame() %>%
  separate(two_crops, into=c("crop1", "crop2")) %>%
  filter( crop1 != "NA")
 
seq_dat %>%
  ggplot(aes(x=crop1, y=crop2, z=avg_total)) +
  stat_bin2d() +
  scale_fill_gradient(low="#e5f5e0", high="#31a354") +
  ggtitle('Occurrence of sequential crops') +
  theme(legend.position='bottom')

seq_dat %>% 
  group_by(crop1, crop2) %>%
  summarise(avg_total = mean(avg_total)) %>%
  ggplot(aes(x=crop1, y=crop2, z=avg_total)) +
  stat_summary2d() +
  scale_fill_gradient(low="#e5f5e0", high="#31a354") +
  ggtitle('Expenses by sequential crops') +
  theme(legend.position='bottom')
```

Corn is by far the most expensive crop, but it's interesting to note that it was most expensive when following hay and next most when following soy beans. We can investigate whether there are any additional expenses involved with this sequence of crops in the data.



